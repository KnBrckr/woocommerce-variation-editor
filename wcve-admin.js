/*
	Only send form fields that have been modified
 */
function MarkAsChanged(){
    jQuery(this).addClass("changed");
}

jQuery(document).ready(function() {
	/*
		Setup tracking of changed cells, reduces data sent on submit
	*/
	jQuery(".wcve-cell").change(MarkAsChanged);
	jQuery(".wcve-checkbox").change(MarkAsChanged);
	jQuery(".wcve-select").change(MarkAsChanged);
	
	jQuery("input[type=submit]").click(function(){
	    jQuery(".wcve-cell:not(.changed)").attr("disabled", "disabled");
	});
	
	/*
		Initialize media manager support for image selection
	*/
	wcve_media_init('.wcve-image-selector');	
}); // End ready()

/*
	FIXME As manage_stock is checked/unchecked show/hide the related managed fields
*/

/*
	Media Manager for selecting images to be used for variations

    Expects images to be formatted as <div class="wcve-image-selector"><input type="hidden"><img></div>
*/
var wcve_media_init = function(selector)  {
    var clicked_image = false;
 
    jQuery(selector).each(function (i, input) {
        var image = jQuery(input).find('img');
        image.click(function (event) {
            event.preventDefault();
            clicked_image = jQuery(this);
 
            // check for existing media manager instances
			if(wp.media.frames.wcve_frame) {
			    wp.media.frames.wcve_frame.open();
			    return;
			}
			
            // configuration for new instance of the media manager
			wp.media.frames.wcve_frame = wp.media({
			   title: 'Select image',
			   multiple: false,
			   library: {
			      type: 'image'
			   },
			   button: {
			      text: 'Use selected image'
			   }
			});
			
            // Function used for the image selection and media manager closing
            var wcve_media_set_image = function() {
                var selection = wp.media.frames.wcve_frame.state().get('selection');
 
                // no selection
                if (!selection) {
                    return;
                }
 
                // iterate through selected elements
                selection.each(function(attachment) {
                    var url = attachment.attributes.sizes.thumbnail.url;	// URL to the selected image
					var id = attachment.attributes.id;						// id of the selected image
					
					/*
						Update thumbnail and hidden input field with selected image.
					*/
					clicked_image.prop('src', url);
					clicked_image.siblings('input').val(id).addClass('changed');
                });
            };
 
            // closing event for media manger
            wp.media.frames.wcve_frame.on('close', wcve_media_set_image);
            // image selection event
            wp.media.frames.wcve_frame.on('select', wcve_media_set_image);
            // showing media manager
            wp.media.frames.wcve_frame.open();
       });
   });
};