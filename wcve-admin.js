/*
	Only send form fields that have been modified
 */
function MarkAsChanged(){
    jQuery(this).addClass("changed");
}

/*
	Check/uncheck boxes in column based on mass-edit setting
*/
function WcveMassChange() {
	/*
		name of clicked checkbox will be form 'all_<class_name>' where class_name identifies the column of data cells
	    corresponding to this master setting
	*/
	className = jQuery(this).attr('name').substring(4);
	inputType = jQuery(this).attr('type');
	
	switch (inputType) {
	case "checkbox":
		checked = jQuery(this).attr('checked') ? true : false;
		jQuery('.' + className + ' input[type=checkbox]').prop('checked', checked).addClass("changed");
		break;
		
	case "text":
	case "number":
		value = jQuery(this).val();
		jQuery('.' + className + ' input[type=' + inputType + ']').val(value).addClass("changed");
		break;
	default:
	}
}

jQuery(document).ready(function() {
	/*
		Setup tracking of changed cells, reduces data sent on submit
	*/
	jQuery(".wcve-cell").change(MarkAsChanged);
	jQuery(".wcve-checkbox").change(MarkAsChanged);
	jQuery(".wcve-select").change(MarkAsChanged);
	
	jQuery("input[type=submit]").click(function(){
	    jQuery(".wcve-cell:not(.changed)").attr("disabled", "disabled");
	});
	
	/*
		Input fields in the mass-edit row manipulate others in the same column
	*/
	jQuery("input.wcve-edit-all-item").change(WcveMassChange);
	
	/*
		Initialize media manager support for image selection
	*/
	wcve_media_init('.wcve-image-selector');	
}); // End ready()

/*
	TODO As manage_stock is checked/unchecked show/hide the related managed fields
*/

/*
	Media Manager for selecting images to be used for variations

    Expects images to be formatted as <div class="wcve-image-selector"><input type="hidden"><img></div>
*/
var wcve_media_init = function(selector)  {
    var clicked_item = false;
 
    jQuery(selector).each(function (i, input) {
        var image = jQuery(input);
        image.click(function (event) {
            event.preventDefault();
			
            clicked_item = jQuery(this);
			
            // check for existing media manager instances
			if(wp.media.frames.wcve_frame) {
			    wp.media.frames.wcve_frame.open();
			    return;
			}
			
            // configuration for new instance of the media manager, allow only single image selection
			wp.media.frames.wcve_frame = wp.media({
			   title: 'Select image',
			   multiple: false,
			   library: {
			      type: 'image'
			   },
			   button: {
			      text: 'Use selected image'
			   }
			});
			
            // Function used for the image selection and media manager closing
            var wcve_media_set_image = function() {
                var selection = wp.media.frames.wcve_frame.state().get('selection');
				var clicked_image = clicked_item.find('img');
				var input = clicked_item.find('input');
				var edit_all = clicked_item.hasClass('wcve-edit-all-item');
 
                // no selection
                if (!selection) {
                    return;
                }
 
                // iterate through selected elements
                selection.each(function(attachment) {
                    var url = attachment.attributes.sizes.thumbnail.url;	// URL to the selected image
					var id = attachment.attributes.id;						// id of the selected image
					
					/*
						Update thumbnail and hidden input field with selected image.
					*/
					clicked_image.prop('src', url).addClass('changed');
					input.val(id).addClass('changed');
					
					/*
						If this was the mass-edit row, update all images in column
					*/
					if (edit_all) {
						cells = jQuery('.thumbnail_id');
						cells.find('img').prop('src', url).addClass('changed');
						cells.find('input').val(id).addClass('changed');
					}
                });
            };
 
            // closing event for media manger
            wp.media.frames.wcve_frame.on('close', wcve_media_set_image);
            // image selection event
            wp.media.frames.wcve_frame.on('select', wcve_media_set_image);
            // showing media manager
            wp.media.frames.wcve_frame.open();
       });
   });
};